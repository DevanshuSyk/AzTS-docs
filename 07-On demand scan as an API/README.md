----------------------------------------------

> The Azure Tenant Security Solution (AzTS) was created by the Core Services Engineering & Operations (CSEO) division at Microsoft, to help accelerate Microsoft IT's adoption of Azure. We have shared AzTS and its documentation with the community to provide guidance for rapidly scanning, deploying and operationalizing cloud resources, across the different stages of DevOps, while maintaining controls on security and governance.
<br>AzTS is not an official Microsoft product – rather an attempt to share Microsoft CSEO's best practices with the community..
# On Demand Scan using API 

### On this page:
- [Overview](README.md#overview)
- [Available APIs](README.md#available-apis)
- [Generate authentication token to access API endpoints](README.md#Generate-authentication-token-to-access-API-endpoints)
- [FAQ](README.md#FAQ)

-----------------------------------------------------------------
## Overview 
The Azure Tenant Security Solution (AzTS) provides APIs which can be leveraged to scan subscription(s) and get control scan result for subscription(s). This is alternative for AzTS UI to get insights about security compliance from AzTS perspective. 

This document will help you out with the following aspects:
1. Available API details:
    <br/>1.1 Request scan
    <br/>1.2 Get scan results
2. Generate authentication token to access API endpoints: <br/>
        2.1 Using client credential flow<br/>
        2.2 Using user authentication code flow<br/>
    
> Note for AzTS admin: This feature is disabled by default. To enable this feature and other pre-requisites, please refer steps(Prerequisite%20Steps.md#prerequisites)


## Available APIs:
|API|Description|
|----|----|
| [Request scan](README.md#11-request-scan---post) |Request ad-hoc scan for subscription(s).|
| [Get scan results](README.md#12-get-latest-scan-results---post) | Get scan results for a subscription.|


## 1.1 Request scan - POST
Request ad-hoc scan for subscription(s).

**Description** <br/>
In order to scan a subscription, you need to provide list of subscription id(s). This API will return status of scan request for all subscriptions along with 'Scan Request Id'. This 'Scan Request Id' can be further used to [get scan results](README.md#12-get-latest-scan-results---post).


``` PowerShell
POST https://<WebAPI-URL>/adhocscan/RequestScan
```
Note: 'WebAPI-URL' varies per AzTS setup. You need to reach out to AzTS admin to get value for `<WebAPI-URL`> as mentioned here.(README.md#how-to-get-webapi-url-with-the-help-of-azts-admin)><br/>

**Request Header**
|Param Name|Description|Required?
|----|----|----|
| Authorization| Bearer Token which can be generated by following steps here. <todo> | Yes|


**Request Body**

|Param Name|Type| Description|Required?
|----|----|----|----|
| SubscriptionIDList|List`<string`>| List of subscription id(s) for scan.| Yes|

**Permissions**
As listed here (README.md#what-are-the-permissions-required-to-use-azts-apis)

**Example** <br/>
**Sample Request**
``` 
 POST https://AzSK-AzTS-WebApi-xxxxx/adhocscan/RequestScan
```
<br/> 

**Sample Request Body**

```JSON
{
    "SubscriptionIDList": [
        "48f73dab-a34c-49a5-b5f5-db1285d422c7",
        "1c38e61e-b8ec-4db5-a98d-43d4662958b9"
    ]
}
```
**Sample Response**
``` JSON
[
    {
        "subscriptionID": "48f73dab-a34c-49a5-b5f5-db1285d422c7",
        "jobID": "20210914014045",
        "queueStatus": "Processing",
        "message": "Subscription added to the queue",
        "timeSpan": "9/14/2021 1:40:45 PM",
        "scanRequestId": "20210914014045"
    },
    {
        "subscriptionID": "1c38e61e-b8ec-4db5-a98d-43d4662958b9",
        "jobID": "20210914014045",
        "queueStatus": "Processing",
        "message": "Subscription added to the queue",
        "timeSpan": "9/14/2021 1:40:45 PM",
        "scanRequestId": "20210914014045"
    }
]
```
> **Note:** 
> </br>
> 1. On demand scan for each subcription can be requested maximum 10 times in a day.
> 2. Use **scanRequestId** to get latest scan results.

[Back to top…](README.md#On-this-page)

## 1.2 Get latest scan results - POST
Get latest scan results for a subscription.

**Description**
<br/>To get latest scan results, you need to pass Subscription Id. 

``` PowerShell
POST https://<WebAPI-URL>/adhocscan/subscription/{subscriptionId}/ControlScanResult
```
Note: 'WebAPI-URL' varies per AzTS setup. You need to reach out to AzTS admin to get value for `<WebAPI-URL`> as mentioned here.(README.md#how-to-get-webapi-url-with-the-help-of-azts-admin)><br/>

**URI Parameters**
|Name|Type|Description|Required?|
|----|----|----|----|
| SubscriptionId |  GUID|Subscription Id | Yes |

**Request Header**

|Param Name|Description|Required?
|----|----|----|
| Authorization| Bearer Token which can be generated by following steps here(README.md#generate-authentication-token-to-access-api-endpoints). | Yes|

**Request Body**
|Name|Type|Description|Required?
|----|----|----|----|
| ScanRequestId |string| To get scan results with respect to the scan request id. | Yes |
| ControlIdList| List`<string`>|List of Control Ids to get scan results only for specific controls.| No |
| ResourceNameList | List`<string`>| List of resources to get scan results only for certain resources.| No |

**Permissions**
As listed here(README.md#what-are-the-permissions-required-to-use-azts-apis)

**Example** <br/>
**Sample Request**
``` 
 POST https://AzSK-AzTS-WebApi-xxxxx/adhocscan/subscription/{subscriptionId}/ControlScanResult
```
<br/> 

**Sample Request Body**

```JSON
{
    "ScanRequestId":  "20210914014045"
}
```
**Sample Response**
``` JSON
[
    {
        "ControlName": "Azure_Storage_DP_Encrypt_In_Transit",
        "ControlDisplayName": "Enable Secure transfer to storage accounts",
        "Status": "Failed",
        "ResourceName": "htc-str-pre-prod-1",
        "ResourceGroupName": "AzSKTestRG",
        "ResourceID": "/subscriptions/48f73dab-a34c-49a5-b5f5-db1285d422c/resourceGroups/HTCRG/providers/Microsoft.Storage/storageAccounts/htc-str-pre-prod-1",
        "IsBaseline": "true",
        "Severity": "High",
        "StatusReason": "Storage secure transfer is not enabled",
        "SubscriptionId": "48f73dab-a34c-49a5-b5f5-db1285d422c",
        "OrgTenantId": "524c134f-eae7-4d9e-b007-ebf8f9d6468f",
        "ExceptionExpiryDate": "",
        "Justification": "",
        "Description": "HTTPS protocol must be used for accessing Storage Account resources",
        "Category": "Encrypt data in transit",
        "Remediation": "Run command 'Set-AzStorageAccount -ResourceGroupName <RGName> -Name <StorageAccountName> -EnableHttpsTrafficOnly `$true'. Run 'Get-Help Set-AzStorageAccount -full' for more help.",
        "ExceptionWorkFlowStatus": ""
    }
]
```

> **Note:**
> 1. If 'RequestBody' is empty or scanRequestId is in the past, then API will return latest scan results.
> 2. You can get scan results <b>only for one subscription at a time</b>.    

[Back to top…](README.md#On-this-page)

## Generate authentication token to access API endpoints
User has to generate authentication token in order to use AzTS APIs.
There are two ways to generate access tokens:
- Option 1: Using user authentication code flow
- Option 2: Using client credential flow


**Required Az Module**
``` PowerShell
Install-Module -Name MSAL.PS -AllowClobber -Scope CurrentUser -repository PSGallery
```
### Option 1: Using user authentication code flow
User authentication code flow uses user's crediential to generate the token.
> Note: You will need to contact AzTS admin to get `<client-app-id`> and `<WebAPI-scope`> required to generate token using this flow. 

**Command to generate the token:**
``` PowerShell

$token = Get-MsalToken -TenantId '<tenant-id>' -ClientId '<client-app-id>' -RedirectUri 'https://localhost' -Scopes '<WebAPI-scope>'

```
> Note: This token is intented to access AzTS API endpoints and not subscriptions.

[Back to top…](README.md#On-this-page)


### Option 2: Using client credential flow
Client crediential flow uses the client credentials (client id and client secret) to generate the token. You will need to register a new Azure AD application and ask AzTS admin to provide permissions by following steps mentioned over here(README.md#what-are-the-permissions-required-to-use-azts-apis).AzTS admin will also provide scope of the WebAPI for which token has to be generated.
You can use following PowerShell command to generate access token. This token will be generated against specified SPN (Service Principal Name) and **SPN must have [required](README.md#what-are-the-permissions-required-to-use-azts-apis) access over the subscription** to use AzTS APIs.

**Command to generate the token:**
``` PowerShell
# Add client secret key of client app registration created in Step-1.
$ClientSecret = '<client-secret>' | ConvertTo-SecureString -AsPlainText -Force

$token = Get-MsalToken -TenantId '<tenant-id>' -ClientId '<client-id>' -ClientSecret $ClientSecret -Scopes "<WebAPI-scope>/.default"

```
> Note: This token is intented to access AzTS API endpoints and not subscriptions.

[Back to top…](README.md#On-this-page)


## FAQ

### How to get WebAPI URL with the help of AzTS admin?
1. Go to Azure Portal.
2. Go to **Resource Groups**.
3. Select your Resource Group where you have configured AzTS set up.
4. Select the App Service for API 'AzSK-ATS-WebAPI-xxxxx'.
5. In **Overview** section, copy **URL**.



### What are the permissions required to use AzTS APIs?
You must have permission over a subscription with any of the following role:
- Owner
- Contributor
- ServiceAdministrator
- CoAdministrator
- AccountAdministrator
- Security Reader
- Security Admin
> **Note:** If you have been recently granted access to a subscription, you would be access AzTS APIs after 24 hours as it takes 24 hours to refresh latest RBAC.

### What are the steps for AzTS admin to grant the permission for requested Client app?
1. Go to Azure Portal.
2. Go to **App Registration**.
3. Select WebAPI App Registration.
4. Go to **Add a client application**.
5. Add client id of request client app.
6. Enable the check box **Authorized scopes**.
7. Add application.
8. Copy scope from 'Scopes'.

[Back to top…](README.md#On-this-page)

## Feedback

For any feedback contact us at: aztssup@microsoft.com 

[Back to top…](README.md#On-this-page)