# Onboarding tenants to multi-tenant AzTS Solution

<br>

## On this page:
  - [Prerequisite](#prerequisite)
  - [Access token generation](#access-token-generation)
  - [Onboarding](#onboarding)
  - [Offboarding](#offboarding)

--------------------------------------------------
<br>

## Prerequisite

Below are the prerequisites for any tenant to be onboarded to AzTS solution for security visibility:
1. SPN for the central scanning identity i.e. multi-tenant AAD application, which was created in step 4 of the deployment procedure, must be created in the tenant.
2. The SPN must be granted below graph permission in the tenant.

    a. MSGraphPermissions
    
        PrivilegedAccess.Read.AzureResources
        Directory.Read.All
        
    b. ADGraphPermissions
    
        Directory.Read.All
        
3. The SPN must be granted "Reader" permission to all the subscriptions in the tenant.
4. The tenant should have Azure active directory license which supports Privileged Identity Management (PIM).
5. Microsoft Defender for cloud should be enabled with standard tier for all the subscription in the tenant.

> **Note:**<br>**1.** Above mentioned prerequisites needs to be provisioned for **each tenant** that is to be onboarded to AzTS solution for security visibility.<br>**2.** Prerequisites #1 to #3 are mandatory for every tenant that is to be onboarded to AzTS solution. Kindly refer these commands to provision the same.<br>**3.** For prerequisite #3 its recommended to grant the SPN, "Reader" permission on root management group. This would ensure that any new subscription added to the tenant would be automatically picked up in next scan.<br>**4.** Prerequisites #4 and #5 are non-mandatory but will impact control evaluation if not done.

--------------------------------------------------
<br>

## Access token generation

Access token for invoking the onboarding/offboarding APIs can be generated using the below steps:
1. [Register an Azure AD application](https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app#register-an-application) in the **host tenant**. This will be used to get an access token for invoking onboarding/offboarding APIs. Skip this step if Azure AD application is already present.
> **Note:** Same AAD application can be used to onboard/offboard more tenants to the AzTS solution in future. Avoid multiple AAD application creation.
2. [Create secret for above application](https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app#add-credentials) and store it at secure location for later reference.
3. Generate the access token using the below commands in powershell session
``` PowerShell
Install-Module -Name MSAL.PS -AllowClobber -Scope CurrentUser -repository PSGallery

$ClientSecret = '<client-secret>' | ConvertTo-SecureString -AsPlainText -Force

$token = Get-MsalToken -TenantId '<tenant-id>' -ClientId '<client-id>' -ClientSecret $ClientSecret -Scopes "<webapi-scope>/.default"

```

> **Note:**<br>- **tenant-id** is the host tenant id for AzTS solution.<br>- **client-id** is the application id of the AAD application created in Step 1.<br>- **client-secret** is the secret of the AAD app created in step 2.<br>- **webapi-scope** could be fetched from here.

--------------------------------------------------
<br>

## Onboarding

Tenants could be onboarded to the multi-tenant AzTS solution using the newly introduced onboarding API, details for which are mentioned below.

**Request URL**

``` PowerShell
POST https://<AzTS WebAPI-URL>/multitenantaction/onboardoffboardtenants?api-version=1.0
```
<br/>

**URI Parameters**
|Name|In|Type|Description|Required?|
|----|----|----|----|----|
| api-version | query | string | Version of the API to use. | No |

**Request Header**

|Param Name|Description|Required?|
|----|----|----|
| Authorization| Bearer token which can be generated by following steps [here](../Authentication%20flow%20for%20AzTS%20REST%20APIs.md#authentication-flow-for-azts-rest-apis). | Yes|

**Request Body**
|Name|Type|Description|Required?|
|----|----|----|----|
| Tenants |List`<TenantDetails>`| List of `TenantDetails` object representing Tenants to be onboarded to AzTS. | Yes |
  
**TenantDetails**
|Name|Type|Description|Required?|
|----|----|----|----|
| TenantId |string| Tenant Id. | Yes |
| TenantName| string|Tenant Name.| Yes |
| Category | string| Category of the Tenants (Learning/Demo/Support/POC).| Yes |
| TenantStatus |string| "Enabled" in case of Onboarding. | Yes |
| ManagementGroupId | string|Root Management Group Id (Same as Tenant Id).| Yes |
| AADLicense | string| Azure Active Directory license of the Tenant.| Yes |

<br/>

## **Example** 
<br/>

**Sample Request**

``` 
 POST https://AzSK-AzTS-WebApi-xxxxx/multitenantaction/onboardoffboardtenants?api-version=1.0
```
<br/> 

**Sample Request Body**

```JSON
{
    "Tenants": [
        {
            "TenantId": "e60xxxxx-xxxx-xxxx-xxxx-xxxxxxxx7830",
            "TenantName": "mpxxxxxxxxxxxxxx",
            "Category": "Learning",
            "TenantStatus": "Enabled",
            "ManagementGroupId": "CoxxxxxxxxxxxMG",
            "AADLicense": "Azure AD Free"
        },
        {
            "TenantId": "e72xxxxx-xxxx-xxxx-xxxx-xxxxxxxx8688",
            "TenantName": "Dexxxxxxxxxxxxxx",
            "Category": "Learning",
            "TenantStatus": "Enabled",
            "ManagementGroupId": "DexxxxxxxMG",
            "AADLicense": "Azure AD Free"
        }
    ]
}
```

**Sample Response**

``` JSON
200 OK
```

--------------------------------------------------
<br>

## Offboarding

Tenants could be offboarded from the multi-tenant AzTS solution using the newly introduced offboarding API, details for which are mentioned below.

**Request URL**

``` PowerShell
POST https://<AzTS WebAPI-URL>/multitenantaction/onboardoffboardtenants?api-version=1.0
```
<br/>

**URI Parameters**
|Name|In|Type|Description|Required?|
|----|----|----|----|----|
| api-version | query | string | Version of the API to use. | No |

**Request Header**

|Param Name|Description|Required?|
|----|----|----|
| Authorization| Bearer token which can be generated by following steps [here](../Authentication%20flow%20for%20AzTS%20REST%20APIs.md#authentication-flow-for-azts-rest-apis). | Yes|

**Request Body**
|Name|Type|Description|Required?|
|----|----|----|----|
| Tenants |List`<TenantDetails>`| List of `TenantDetails` object representing Tenants to be offboarded from AzTS. | Yes |
  
**TenantDetails**
|Name|Type|Description|Required?|
|----|----|----|----|
| TenantId |string| Tenant Id. | Yes |
| TenantStatus |string| "Disabled" in case of Offboarding. | Yes |

<br/>

## **Example** 
<br/>

**Sample Request**

``` 
 POST https://AzSK-AzTS-WebApi-xxxxx/multitenantaction/onboardoffboardtenants?api-version=1.0
```
<br/> 

**Sample Request Body**

```JSON
{
    "Tenants": [
        {
            "TenantId": "e60xxxxx-xxxx-xxxx-xxxx-xxxxxxxx7830",
            "TenantStatus": "Disabled"
        },
        {
            "TenantId": "e72xxxxx-xxxx-xxxx-xxxx-xxxxxxxx8688",
            "TenantStatus": "Disabled"
        }
    ]
}
```

**Sample Response**

``` JSON
200 OK
```




<br/>
